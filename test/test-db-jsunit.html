<html>
	<head>
		<title>Test Page for jsormdb</title>
		<script language="javascript" src="../../jsunit/app/jsUnitCore.js"></script>
		<script src="../build/jsormdb-src.js"></script>
		<script type="text/javascript">
		var db = [], r, idx, inRunner = false, setUpPageStatus, i, maxplain=8, maxload=4, max=maxplain+maxload;
		var completed = 0, setUpPageStatus;
		var initval = [{name:"John",age:25},{name:"Jill",age:18},{name:"Jack",age:60},{name:"Jeri",age:45},{name:"Jono",age:12}];
		var newval = [{name:"Karl",age:25},{name:"Kelly",age:18},{name:"Kris",age:60},{name:"Knute",age:45},{name:"Kandy",age:12}];
		var jsonO = '{"root":[{"name":"John","age":25},{"name":"Jill","age":18},{"name":"Jack","age":60},{"name":"Jeri","age":45},{"name":"Jono","age":12}]}';
		var jsonA = '[{"name":"John","age":25},{"name":"Jill","age":18},{"name":"Jack","age":60},{"name":"Jeri","age":45},{"name":"Jono","age":12}]';
		
		

		// initial set up, following which we run the test
		function setUpPage() {
			setup();
		}

		function checkComplete() {
			completed++;
			if (completed === max) {
				setUpPageStatus = 'complete';									
			}
		}

		function setup() {
			var i, conf;
			for (i=0;i<maxplain; i++) {
				db[i] = JSORM.db.db({parser: JSORM.db.parser.object()});
				db[i].load({data: initval, callback: checkComplete});
			}
			// json parser local 8
			db[i] = JSORM.db.db({parser: JSORM.db.parser.json({root: "root"})});
			db[i].load({data: jsonO, callback: checkComplete})
			
			conf = {url: 'data.json'};
			// json parser channel 9
			i++;
			db[i] = JSORM.db.db({parser: JSORM.db.parser.json({root: "root"}), channel: JSORM.db.channel.http(conf)});
			db[i].load({data: jsonO, callback: checkComplete})
			// json parser channel 10
			i++;
			db[i] = JSORM.db.db({parser: JSORM.db.parser.json({root: "root"}), channel: JSORM.db.channel.http(conf)});
			db[i].load({data: jsonO, callback: checkComplete})
			// json parser channel 11
			i++;
			db[i] = JSORM.db.db({parser: JSORM.db.parser.json({root: "root"}), channel: JSORM.db.channel.http(conf)});
			db[i].load({data: jsonO, callback: checkComplete})
		}

		/*
		 * BEGIN TESTS 
		 */
		function testIndex() {
			var i, len;
			idx = JSORM.db.index.hash(["name"]);
			for (i=0, len=initval.length; i<len; i++) {
				idx.add(i,initval[i]);
			}
			r = idx.find({field: "name", compare: "equals", value: "Jill"});
			assertEquals("r returned should be an array","object",typeof(r));
			assertEquals("Indexed name field search should return single record",1,r.length);

			r = idx.find({field: "name", compare: "gt", value: 25});
			assertNull("Greater than should return null",r);

			r = idx.find({field: "age", compare: "gt", value: 25});	
			assertNull("Unindexed field should return null",r);
		}

		function testJsonParser() {
			var parser, j, d;
			
			// set up a parser, with a root of root
			parser = JSORM.db.parser.json({root: "root"});

			d = parser.read(jsonO);

			// check that the results are as expected
			assertEquals("Parse object json records expected",5,d.records.length);
 			//[{name:"John",age:25},{name:"Jill",age:18},{name:"Jack",age:60},{name:"Jeri",age:45},{name:"Jono",age:12}];
			assertEquals("John is first with age 25","John",d.records[0].name);
			assertEquals("John is first with age 25",25,d.records[0].age);
			assertEquals("Jono is last with age 12","Jono",d.records[4].name);
			assertEquals("Jono is last with age 12",12,d.records[4].age);
			
			d = parser.read(jsonA);

			// check that the results are as expected
			assertEquals("Parse object json records expected",5,d.records.length);
 			//[{name:"John",age:25},{name:"Jill",age:18},{name:"Jack",age:60},{name:"Jeri",age:45},{name:"Jono",age:12}];
			assertEquals("John is first with age 25","John",d.records[0].name);
			assertEquals("John is first with age 25",25,d.records[0].age);
			assertEquals("Jono is last with age 12","Jono",d.records[4].name);
			assertEquals("Jono is last with age 12",12,d.records[4].age);
			
			// go to write
			j = parser.write(d.records);
			assertEquals("object to json should be equal",jsonO,j);
			
		}
		
		function loadTestHttpChannel() {
			var channel, loadcb, updatecb;
			loadcb = function(data) {
				var a = 1;
			}
			// test load with loadUrl
			channel = JSORM.db.channel.http({loadUrl: 'data.json'});
			channel.load({callback: loadcb});
			// test load with just url
			channel = JSORM.db.channel.http({url: 'data2.json'});
			channel.load({callback: loadcb, options: {a:1,b:2}});
			
		}

		function testLoad() {
			// check results
			r = db[0].find();
			assertEquals("Number of entries in the database",initval.length,r.length);
		}

		function testFind() {
			// check results
			r = db[1].find();
			assertEquals("Number of entries in the database",initval.length,r.length);

			r = db[1].find({where: {field: "age", compare: "ge", value: 25}});
			assertEquals("Number of entries where age >= 25",3,r.length);

			r = db[1].find({where: {field: "age", compare: "ge", value: 25}, fields: {name: true}});
			assertEquals("Number of entries where age >= 25",3,r.length);
			assertNotUndefined("Should have name for age >= 25",r[0].name);
			assertNotUndefined("Should have name for age >= 25",r[1].name);
			assertNotUndefined("Should have name for age >= 25",r[2].name);
			assertUndefined("Should not have other than name for age >= 25",r[0].age);
			assertUndefined("Should not have other than name for age >= 25",r[1].age);
			assertUndefined("Should not have other than name for age >= 25",r[2].age);

			r = db[1].find({where: {field: "age", compare: "gt", value: 2}});
			assertEquals("Number of entries where age > 2",5,r.length);

			r = db[1].find({where:{field: "age", compare: "gt", value: 2},fields:{age: true}});
			assertEquals("Number of entries where age > 2",5,r.length);
			assertNotUndefined("Should have age for age >= 25",r[0].age);
			assertNotUndefined("Should have age for age >= 25",r[1].age);
			assertNotUndefined("Should have age for age >= 25",r[2].age);
			assertUndefined("Should not have other than age for age >= 25",r[0].name);
			assertUndefined("Should not have other than age for age >= 25",r[1].name);
			assertUndefined("Should not have other than age for age >= 25",r[2].name);

			r = db[1].find({where:{join: "and", terms:[{field: "age", compare: "gt", value: 2}]}});
			assertEquals("Number of entries where age > 2 and an and term",5,r.length);

			r = db[1].find({where: {join: "and", terms:[{field: "age", compare: "gt", value: 2},{field: "name", compare: "starts", value: "Jo"}]}});
			assertEquals("Number of entries where age > 2 AND name starts 'Jo'",2,r.length);

			r = db[1].find({where: {join: "or", terms:[{field: "age", compare: "gt", value: 22},{field: "name", compare: "starts", value: "Ji"}]}});
			assertEquals("Number of entries where age > 22 OR name starts 'Ji'",4,r.length);

		}

		function testUpdate() {
			db[2].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});

			r = db[2].find({where: {field: "age", compare: "gt", value: 25}});
			assertEquals("Number of entries where age > 25 after update",r.length,3);

			r = db[2].find({where: {field: "age", compare: "equals", value: 30}});	
			assertEquals("Number of entries where age == 30 after update",r.length,3);
		}

		function testRemove() {
			db[3].remove({where: {field: "name", compare: "equals", value: "Jill"}});
			r = db[3].find();
			assertEquals("Removed Jill, should have 4 records",4,r.length);

			db[3].remove({where: {field: "name", compare: "equals", value: "Joshua"}});
			r = db[3].find();
			assertEquals("Removed Joshua, should still have 4 records",4,r.length);
		}

		function testInsert() {
			db[4].insert(newval);
			r = db[4].find();
			assertEquals("Added newval without replace",10,r.length);

			db[4].clear();
			db[4].insert(newval);
			r = db[4].find();
			assertEquals("Added newval alone",5,r.length);	
		}

		function testCommit() {
			// db5 has no channel
			db[5].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			db[5].insert(newval);
			db[5].commit();
			
			// db9, 10 and 11 have channels
			db[8].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			db[8].insert(newval);
			db[8].commit({mode: JSORM.db.db.modes.nothing});
			
			db[9].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			db[9].insert(newval);
			db[9].commit({mode: JSORM.db.db.modes.replace});

			db[10].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			db[10].insert(newval);
			db[10].commit({mode: JSORM.db.db.modes.update});

			db[11].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			db[11].insert(newval);
			db[11].commit({mode: JSORM.db.db.modes.condensed});
		}

		function testReject() {
			db[6].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			r = db[6].find({where: {field: "age", compare: "equals", value: 60}});
			assertEquals("Before reject should have none at age 60",0,r.length);
			db[6].insert(newval);
			r = db[6].find({where: {field: "age", compare: "equals", value: 60}});
			assertEquals("Before reject should have one at age 60",1,r.length);
			db[6].reject(2);
			r = db[6].find({where: {field: "age", compare: "equals", value: 60}});
			assertEquals("After reject should have all changes rolled back",1,r.length);

			db[7].update({data: {age: 30}, where: {field: "age",compare:"gt",value:23}});
			db[7].insert(newval);
			r = db[7].find({where: {field: "age", compare: "equals", value: 60}});
			assertEquals("Before reject should have one at age 60",1,r.length);
			r = db[7].find();
			assertEquals("Before reject should have 10 entries",10,r.length);
			db[7].reject(1);
			r = db[7].find({where: {field: "age", compare: "equals", value: 60}});
			assertEquals("After reject of insert but not update should have none at age 60",0,r.length);
		}
		
		
		</script>
	</head>
	<body>
		<h1>Database Tests</h1>
		<div id="results"></div>
	</body>
</html>
